---
- hosts: research_environment
  become: yes
  become_method: sudo
  roles:
    - {role: iptables, when: "iptables_config"}
    - {role: common, when: "install_glusterfs"}
  tasks:
    - name: research eod symlinks
      file:
         src: "{{ item.src }}"
         dest: "{{ item.dest }}"
      with_items: eod_symlinks 

  tasks:
    - name: Ensure X11 Forwarding is present
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: ^\s*X11Forwarding=no
        line: X11Forwarding=yes

    - name: Ensure ClientAliveCountMax is set to correct value
      lineinfile:
        dest: /etc/ssh/sshd_config 
        regexp: ClientAliveCountMax
        line: ClientAliveCountMax=384

    - name: additional symlinks for odbc.ini, odbcinst.ini, freetds, cups to shared env
      file:
        state: link
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      with_items: "{{ additional_symlinks }}"

    - name: Add additional software to all Research servers
      yum:
         name: "{{ item }}" 
         state: present
      with_items:
         - htop
         - cups
         - hplip
         - gutenprint
         - foomatic
         - udev
         - firefox
         - system-config-printer
         - postgresql-odbc
 
    - name: Add Postgresl repository on all Research servers
      yum: 
        name: "{{ eod_postgres_repository_url }}" 
 
    - name: Install postgres repository key
      rpm_key:
        key: "{{ eod_postgres_repository_key_url }}"
        state: present
 
    - name: Ensure older versions of postgres is removed
      yum:
        name: "{{ item }}"
        state: absent
        disablerepo: "{{ eod_postgres_repository_name }}"
      ignore_errors: yes
      with_items: "{{ eod_postgres_old_packages }}"
      when: eod_clean_postgresql
 
    - name: Install the required latest postgres packages
      yum:
        name: "{{ item }}"
        state: present
      with_items: "{{ eod_postgres_packages }}"

    - name: Add psql bin directory to path
      lineinfile:
        dest: /etc/profile.d/postgres.sh
        create: yes
        line: export PATH={{ eod_postgres_install_dir }}/bin:$PATH
        mode: 0644
 
    - name: Add /etc/devfs.rules file to research env servers
      template:
        src: devfs.rules
        dest: /etc/devfs.rules
        mode: 0644

    - name: Add rc.conf file to all research env servers
      template:
        src: rc.conf    
        dest: /etc/rc.conf 
        mode: 0644

- hosts: research_ancillary_services
  become: yes
  become_method: sudo
  roles:
    - devtools
    - emacs
    - open_office
    - evince
    - stattransfer
    - odbc
    - sublime
    - jdk

  tasks:
    - name: Install Ultra Edit
      yum:
        name: UltraEdit.x86_64
        state: present
        disable_gpg_check: yes
      when: custom_repo
 
    - name: Install texlive
      yum:
        name: texlive
        state: present

- hosts: research_eod
  become: yes
  become_method: sudo
  roles:
    - eod

- hosts: research_gauss
  become: yes
  become_method: sudo
  roles:
    - gauss
    - odbc
    - gocd
    - stattransfer

- hosts: research_stata
  become: yes
  become_method: sudo
  roles:
    - stata
    - odbc
    - stattransfer

- hosts: research_python
  become: yes
  become_method: sudo
  roles:
    - devtools
    - {role: python, when: "custom_repo"}
    - {role: python-build, when: "not custom_repo"}
    - {role: python3, when: "custom_repo"}
    - {role: python3-build, when: "not custom_repo"}
    - {role: epel, when: "use_epel"}
    - jdk
    - postgresql-client
    - r
    - r-studio-desktop
    - r-studio-server
    - pycharm
    - odbc
    - gocd
    - stattransfer
  tasks:
    - name: Install Python RPM dependencies
      yum:
        name: "{{ item }}"
        state: present
        disable_gpg_check: yes
      with_items: python_dep_packages

    - name: Install Python packages for 27
      pip:
        name: "{{ item }}"
        state: present
        executable: /usr/local/bin/pip2.7
      with_items: python_packages

    - name: Install Python packages for 34
      pip:
        name: "{{ item }}"
        state: present
        executable: /usr/local/bin/pip3.4
      with_items: python3_packages

- hosts: research_sas
  become: yes
  become_method: sudo
  roles:
    # - sas
    - odbc
    - gocd
    - stattransfer

  tasks:
    - name: install libXp
      yum:
        name: libXp
        state: present

- hosts: research_spss
  become: yes
  become_method: sudo
  roles:
    # - spss
    - odbc
    - gocd
    - stattransfer

- hosts: research_matlab
  become: yes
  become_method: sudo
  roles:
    # - matlab
    - odbc
    - gocd
    - stattransfer
  tasks:
  - name: Install libselinux-python and libicu package 
    yum:
      name: "{{ item }}" 
      state: present
      disable_gpg_check: yes 
    with_items: 
      - libicu 
      - libselinux-python
